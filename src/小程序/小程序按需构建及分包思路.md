## 按需构建

现在的流程：

faas请求应用数据(包括页面/组件/导航等) =>  构建脚本处理文件 => 执行构建。

![image-20211224151044582](images/image-20211224151044582.png)

### 按需，按什么需？

要做到按需构建，首先得知道我们的需求。

- 只构建当前使用的组件？
- 只构建当前引用的组件包？
- 全量构建

第一种方案，简单粗暴，但难以升级。每一次小程序构建都只打包当前设计器内拖放了的组件，这样一来虽然保证了当前的小程序包总体积最小，但对用户来说可能会难以接受，因为如果想要做到不提审更新元数据，用户只能使用当前版本已使用的组件，只要有之前没有拖放进设计器的组件，就需要走重新提审发布的流程。

第二种方案，只构建当前使用了的组件包。每次小程序构建时只打包当前使用到的组件列表所引用的组件包，这种情况下只要做好组件的分类和产品层面的限制（比如单个页面不能使用超过3个以上组件包的组件，用这样的方式去促使用户对组件做好分类），其实算是当前阶段比较合适的策略。

第三种，全量构建。只要用户引用到了的组件包，都打包进小程序内，达到最高的灵活性。

我们的终极目标当然是第三种，但是需要有非常完善的方案去实现。

### 分包策略

基于可行性，我们按两个方向来展开讨论。

### 不做分包异步化

不做分包异步化的情况下，微信小程序存在以下限制：

- 主包 2M
- 每个分包 2M
- 总体积 20M

可以看出来存在很大问题，主包总体积只有2M，除去框架运行时和SDK等内置代码之外，我们只有1.5M左右的体积供组件包使用才能保证小程序体积在一个合理的范围，产品层面可以从以下方面考虑：

- 在组件包注册时进行检测，对组件包总体积/单个组件体积进行限制（比如: 单个组件包代码总体积不超过1M，组件数量不超过20个）
- 限制页面个数
- 单页面限制引用组件包个数
- 限制主包引用的组件包（可以是系统组件+客户自选的模式，比如主包引用的组件包不超过5个）

那么我们的分包策略（不基于分包异步化）简单来说类似：

- **只有 tabbar 页面打包进主包，对应引用的组件包进主包**
- 其他页面及其引用的组件包（除主包已引用的之外）全部打进分包
- 对组件包引用频率进行排序，引用频率较高的组件包和对应的页面打入同一分包，其他依次同理（如某个组件包被10个页面引用了，那么我们就将这10个页面和其引用的组件包打进一个分包，这里需要有更加详细的算法）
- 不依赖主包功能的打入独立分包
- 必要时将同一个组件包复制多份打入不同的分包

### 分包异步化

虽然但是，分包异步化一定是我们的终极解决方案。

分包异步化需要的最低基础库版本为 2.17.3，当前线上基础库占比已经达到了94%+（[基础库版本分布统计](https://developers.weixin.qq.com/miniprogram/dev/framework/client-lib/version.html)），再等待一段时间就可以升级了。

在分包异步化的前提下，我们可以按照组件包的粒度来进行分包，同样地：

- 组件包注册/升级时检测，限制单个组件包体积
- 构建前检测，限制所有组件包的总体积
- 按组件包引用频率来统计，**主包(tabbar)页面使用频率较高的组件包打入主包内**，其他打入分包，运行时异步加载
- 对组件包引用频率进行排序，引用频率较高的组件包和对应的页面打入同一分包，其他同理逐个合并
- 不依赖主包功能的打入独立分包

### 其他

配合以上的策略，还需要做分包预加载等。





















